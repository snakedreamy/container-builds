name: 构建并发布 n8n-runner 镜像

on:
  push:
    branches: [ "main" ]
    paths:
      - "images/n8n-runner/**"
      - ".github/workflows/build-n8n-runner.yml"

  workflow_dispatch:

  schedule:
    - cron: "15 */6 * * *"  # 每 6 小时一次（UTC）

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 获取 n8nio/runners:latest 的 digest（用于判断上游是否更新）
      - name: 获取上游 runners:latest 的 digest（作为更新判断依据）
        id: upstream
        run: |
          set -euo pipefail

          LATEST_JSON="$(curl -fsSL "https://hub.docker.com/v2/repositories/n8nio/runners/tags/latest")"

          # 优先取 linux/amd64 digest 作为“变化 key”
          LATEST_DIGEST="$(
            echo "${LATEST_JSON}" \
            | jq -r '( .images[] | select(.os=="linux" and .architecture=="amd64") | .digest ) // empty' \
            | head -n 1
          )"

          if [ -z "${LATEST_DIGEST}" ] || [ "${LATEST_DIGEST}" = "null" ]; then
            LATEST_DIGEST="$(echo "${LATEST_JSON}" | jq -r '.images[0].digest')"
          fi

          if [ -z "${LATEST_DIGEST}" ] || [ "${LATEST_DIGEST}" = "null" ]; then
            echo "无法获取 runners:latest digest（Docker Hub API 可能变更）" >&2
            exit 1
          fi

          SHORT_DIGEST="$(echo "${LATEST_DIGEST}" | sed 's/^sha256://g' | cut -c1-12)"

          echo "latest_digest=${LATEST_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "short_digest=${SHORT_DIGEST}" >> "$GITHUB_OUTPUT"

          echo "上游 runners:latest digest = ${LATEST_DIGEST}"
          echo "上游 runners:latest short  = ${SHORT_DIGEST}"

      # 2) 登录 GHCR
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3) 如果 GHCR 已有该 digest 版本则跳过
      - name: 如果 GHCR 已有该 digest 版本且包含 arm64 则跳过
        id: check
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository_owner }}/n8n-runner:digest-${{ steps.upstream.outputs.short_digest }}"

          # 先看 tag 是否存在
          if ! docker manifest inspect "${IMAGE}" >/dev/null 2>&1; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "GHCR 不存在：${IMAGE}，将执行构建"
            exit 0
          fi

          # 再检查 manifest 里是否包含 arm64
          # 这里用 jq 判断是否存在 architecture=arm64 的条目
          if docker manifest inspect "${IMAGE}" | jq -e '.manifests[] | select(.platform.architecture=="arm64")' >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "GHCR 已存在且包含 arm64：${IMAGE}，跳过构建"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "GHCR 已存在但缺少 arm64：${IMAGE}，强制重建"
          fi

      # 4) 多架构构建需要 QEMU + buildx
      - name: 启用 QEMU（跨架构构建）
        if: steps.check.outputs.exists != 'true'
        uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists != 'true'

      # 5) 构建并推送（多架构）
      - name: 构建并推送 n8n-runner 镜像（多架构）
        if: steps.check.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          # 关键：context 指向镜像目录，这样 COPY 才能找到 n8n-task-runners.json
          context: images/n8n-runner
          file: images/n8n-runner/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RUNNERS_VERSION=latest
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n-runner:latest
            ghcr.io/${{ github.repository_owner }}/n8n-runner:digest-${{ steps.upstream.outputs.short_digest }}
            ghcr.io/${{ github.repository_owner }}/n8n-runner:sha-${{ github.sha }}