name: é€šç”¨æ„å»ºå¹¶å‘å¸ƒé•œåƒï¼ˆReusableï¼‰

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string

      context:
        required: true
        type: string
      dockerfile:
        required: true
        type: string

      upstream_image:
        required: true
        type: string

      version_source:
        required: false
        type: string
        default: github_release

      upstream_repo:
        required: false
        type: string
        default: ""

      version_sed:
        required: false
        type: string
        default: "s/^v//; s/^n8n@//"

      upstream_tag_template:
        required: false
        type: string
        default: "{version}"

      upstream_tag:
        required: false
        type: string
        default: ""

      platforms:
        required: false
        type: string
        default: "linux/amd64,linux/arm64"

      version_arg_name:
        required: false
        type: string
        default: ""

      extra_build_args:
        required: false
        type: string
        default: ""

      push_latest:
        required: false
        type: boolean
        default: true
      push_version:
        required: false
        type: boolean
        default: true
      push_build_key:
        required: false
        type: boolean
        default: true
      push_digest_tag:
        required: false
        type: boolean
        default: false

      extra_tag_suffixes:
        required: false
        type: string
        default: ""

      concurrency_group:
        required: false
        type: string
        default: ""

      # âœ… æ›´ç°ä»£/æ ‡å‡†/å®‰å…¨ï¼šSBOM & Provenance
      enable_provenance:
        required: false
        type: boolean
        default: true
      enable_sbom:
        required: false
        type: boolean
        default: true

    outputs:
      should_build:
        value: ${{ jobs.build.outputs.should_build }}
      version:
        value: ${{ jobs.build.outputs.version }}
      upstream_digest:
        value: ${{ jobs.build.outputs.upstream_digest }}
      build_key:
        value: ${{ jobs.build.outputs.build_key }}

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ inputs.concurrency_group != '' && inputs.concurrency_group || format('build-{0}', inputs.image_name) }}
      cancel-in-progress: true

    outputs:
      should_build: ${{ steps.decide.outputs.should_build }}
      version: ${{ steps.meta.outputs.version }}
      upstream_digest: ${{ steps.upstream.outputs.upstream_digest }}
      build_key: ${{ steps.key.outputs.build_key }}

    steps:
      - uses: actions/checkout@v4

      - name: è§£æç‰ˆæœ¬ä¸ä¸Šæ¸¸å¼•ç”¨ï¼ˆversion / upstream_tag / upstream_refï¼‰
        id: meta
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          MODE="${{ inputs.version_source }}"

          if [ "${MODE}" = "github_release" ]; then
            if [ -z "${{ inputs.upstream_repo }}" ]; then
              echo "é”™è¯¯ï¼šversion_source=github_release æ—¶ï¼Œå¿…é¡»æä¾› upstream_repo" >&2
              exit 1
            fi

            RAW_TAG="$(gh api "repos/${{ inputs.upstream_repo }}/releases/latest" --jq '.tag_name')"
            VERSION="$(echo "${RAW_TAG}" | sed -E '${{ inputs.version_sed }}')"

            if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
              echo "é”™è¯¯ï¼šæ— æ³•è§£æä¸Šæ¸¸ç‰ˆæœ¬å·ï¼ˆtag_name=${RAW_TAG}ï¼‰" >&2
              exit 1
            fi

            if [ -n "${{ inputs.upstream_tag }}" ]; then
              UP_TAG="${{ inputs.upstream_tag }}"
            else
              TEMPLATE="${{ inputs.upstream_tag_template }}"
              UP_TAG="${TEMPLATE//\{version\}/${VERSION}}"
            fi

          elif [ "${MODE}" = "tag" ]; then
            if [ -z "${{ inputs.upstream_tag }}" ]; then
              echo "é”™è¯¯ï¼šversion_source=tag æ—¶ï¼Œå¿…é¡»æä¾› upstream_tagï¼ˆå¦‚ latest/baseï¼‰" >&2
              exit 1
            fi
            UP_TAG="${{ inputs.upstream_tag }}"
            VERSION="${UP_TAG}"
            RAW_TAG="${UP_TAG}"
          else
            echo "é”™è¯¯ï¼šæœªçŸ¥ version_source=${MODE}ï¼ˆä»…æ”¯æŒ github_release / tagï¼‰" >&2
            exit 1
          fi

          UP_REF="${{ inputs.upstream_image }}:${UP_TAG}"

          echo "raw_tag=${RAW_TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "upstream_tag=${UP_TAG}" >> "$GITHUB_OUTPUT"
          echo "upstream_ref=${UP_REF}" >> "$GITHUB_OUTPUT"

          echo "âœ… version=${VERSION}"
          echo "âœ… upstream_ref=${UP_REF}"

      - name: è·å–ä¸Šæ¸¸é•œåƒ Digestï¼ˆè‹¥æœªåŒæ­¥åˆ™è·³è¿‡ï¼‰
        id: upstream
        run: |
          set -euo pipefail
          UP_REF="${{ steps.meta.outputs.upstream_ref }}"

          echo "æ­£åœ¨æ£€æŸ¥ä¸Šæ¸¸ï¼š${UP_REF}"

          if DIGEST="$(docker run --rm quay.io/skopeo/stable:latest inspect "docker://${UP_REF}" --format '{{.Digest}}' 2>/dev/null)"; then
            SHORT="$(echo "${DIGEST}" | sed 's/^sha256://' | cut -c1-12)"
            echo "upstream_available=true" >> "$GITHUB_OUTPUT"
            echo "upstream_digest=${DIGEST}" >> "$GITHUB_OUTPUT"
            echo "short_digest=${SHORT}" >> "$GITHUB_OUTPUT"
            echo "âœ… ä¸Šæ¸¸ Digest: ${DIGEST}"
          else
            echo "upstream_available=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ ä¸Šæ¸¸é•œåƒå°šä¸å¯ç”¨æˆ–æœªåŒæ­¥ï¼ˆ${UP_REF}ï¼‰ï¼Œè·³è¿‡æœ¬æ¬¡æ„å»º"
          fi

      - name: ç™»å½• GHCRï¼ˆç”¨äºæ£€æŸ¥/æ¨é€æœ¬ä»“åº“é•œåƒï¼‰
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: è®¡ç®—æœ¬åœ°æ„å»ºä¸Šä¸‹æ–‡ Hashï¼ˆcontextï¼‰
        if: steps.upstream.outputs.upstream_available == 'true'
        id: ctx
        run: |
          set -euo pipefail
          CONTEXT="${{ inputs.context }}"
          CTX="$( (find "${CONTEXT}" -type f -print0 | sort -z | xargs -0 sha256sum) \
                | sha256sum | awk '{print $1}' | cut -c1-12 )"
          echo "ctx=${CTX}" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ æœ¬åœ°ä¸Šä¸‹æ–‡çŸ­å“ˆå¸Œ: ${CTX}"

      - name: ç”Ÿæˆ Build Keyï¼ˆshort_digest + ctxï¼‰
        if: steps.upstream.outputs.upstream_available == 'true'
        id: key
        run: |
          set -euo pipefail
          UP_SHORT="${{ steps.upstream.outputs.short_digest }}"
          CTX="${{ steps.ctx.outputs.ctx }}"
          BUILD_KEY="${UP_SHORT}-${CTX}"
          echo "build_key=${BUILD_KEY}" >> "$GITHUB_OUTPUT"
          echo "ğŸ”‘ Build Key: ${BUILD_KEY}"

      - name: æ£€æŸ¥ build-<key> æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤æ„å»ºï¼‰
        if: steps.upstream.outputs.upstream_available == 'true'
        id: check
        run: |
          set -euo pipefail
          TARGET="ghcr.io/${{ github.repository_owner }}/${{ inputs.image_name }}"
          IMG="${TARGET}:build-${{ steps.key.outputs.build_key }}"

          echo "æ­£åœ¨æ£€æŸ¥é•œåƒ: ${IMG}"

          if docker manifest inspect "${IMG}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ å·²å­˜åœ¨ï¼ˆåŒ upstream + åŒæœ¬åœ°ä¸Šä¸‹æ–‡ï¼‰ï¼Œè·³è¿‡æ„å»º"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ„å»º"
          fi

      - name: å†³ç­–ï¼šæ˜¯å¦éœ€è¦æ„å»º
        id: decide
        run: |
          set -euo pipefail
          if [ "${{ steps.upstream.outputs.upstream_available }}" != "true" ]; then
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ steps.check.outputs.exists }}" = "true" ]; then
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          fi

      - name: æ¸²æŸ“ tagsï¼ˆå¤šè¡Œï¼‰ä¸ labelsï¼ˆå¤šè¡Œï¼‰
        if: steps.decide.outputs.should_build == 'true'
        id: render
        run: |
          set -euo pipefail

          TARGET="ghcr.io/${{ github.repository_owner }}/${{ inputs.image_name }}"
          VERSION="${{ steps.meta.outputs.version }}"
          BUILD_KEY="${{ steps.key.outputs.build_key }}"
          SHORT="${{ steps.upstream.outputs.short_digest }}"

          TAGS=""

          if [ "${{ inputs.push_latest }}" = "true" ]; then
            TAGS="${TAGS}${TARGET}:latest"$'\n'
          fi
          if [ "${{ inputs.push_version }}" = "true" ]; then
            TAGS="${TAGS}${TARGET}:${VERSION}"$'\n'
          fi
          if [ "${{ inputs.push_build_key }}" = "true" ]; then
            TAGS="${TAGS}${TARGET}:build-${BUILD_KEY}"$'\n'
          fi
          if [ "${{ inputs.push_digest_tag }}" = "true" ]; then
            TAGS="${TAGS}${TARGET}:digest-${SHORT}"$'\n'
          fi

          EXTRA="${{ inputs.extra_tag_suffixes }}"
          if [ -n "${EXTRA}" ]; then
            while IFS= read -r line; do
              line="$(echo "${line}" | xargs || true)"
              [ -z "${line}" ] && continue
              TAGS="${TAGS}${TARGET}:${line}"$'\n'
            done <<< "${EXTRA}"
          fi

          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s' "${TAGS}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "labels<<EOF" >> "$GITHUB_OUTPUT"
          cat <<EOF >> "$GITHUB_OUTPUT"
          org.opencontainers.image.source=${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          io.mu8u.upstream.ref=${{ steps.meta.outputs.upstream_ref }}
          io.mu8u.upstream.digest=${{ steps.upstream.outputs.upstream_digest }}
          io.mu8u.build.key=${{ steps.key.outputs.build_key }}
          EOF
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: æ¸²æŸ“ build-argsï¼ˆå¤šè¡Œï¼‰
        if: steps.decide.outputs.should_build == 'true'
        id: args
        run: |
          set -euo pipefail

          OUT=""

          if [ -n "${{ inputs.version_arg_name }}" ]; then
            OUT="${OUT}${{ inputs.version_arg_name }}=${{ steps.meta.outputs.version }}"$'\n'
          fi

          EXTRA="${{ inputs.extra_build_args }}"
          if [ -n "${EXTRA}" ]; then
            OUT="${OUT}${EXTRA}"$'\n'
          fi

          echo "build_args<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s' "${OUT}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - uses: docker/setup-qemu-action@v3
        if: steps.decide.outputs.should_build == 'true'

      - uses: docker/setup-buildx-action@v3
        if: steps.decide.outputs.should_build == 'true'

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        if: steps.decide.outputs.should_build == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: true
          platforms: ${{ inputs.platforms }}
          build-args: ${{ steps.args.outputs.build_args }}
          tags: ${{ steps.render.outputs.tags }}
          labels: ${{ steps.render.outputs.labels }}
          provenance: ${{ inputs.enable_provenance }}
          sbom: ${{ inputs.enable_sbom }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ç»“æŸï¼ˆè·³è¿‡åŸå› æç¤ºï¼‰
        if: steps.decide.outputs.should_build != 'true'
        run: |
          set -euo pipefail
          if [ "${{ steps.upstream.outputs.upstream_available }}" != "true" ]; then
            echo "æœªæ„å»ºï¼šä¸Šæ¸¸é•œåƒå°šæœªåŒæ­¥æˆ–ä¸å¯ç”¨ï¼ˆ${{ steps.meta.outputs.upstream_ref }}ï¼‰"
          else
            echo "æœªæ„å»ºï¼šbuild-${{ steps.key.outputs.build_key }} å·²å­˜åœ¨ï¼ˆåŒ upstream + åŒæœ¬åœ°ä¸Šä¸‹æ–‡ï¼‰"
          fi