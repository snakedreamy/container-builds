name: 构建并发布镜像（统一入口）

on:
  push:
    branches: ["main"]
    # push 场景：只有当这些路径发生变化才触发
    paths:
      - "images/**"
      - ".github/workflows/build.yml"
      - ".github/workflows/_build-image.yml"

  # 手动触发：可选择构建特定镜像
  workflow_dispatch:
    inputs:
      target:
        description: "选择要构建的镜像"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - n8n
          - n8n-runners
          - vscode-ssh-dev
          - webtop # ✅ 新增：webtop（基于 lscr.io/linuxserver/webtop:ubuntu-xfce）

  schedule:
    # 定时触发（用于“追上游”）
    # 6 小时：n8n / runners 追上游
    - cron: "0 */6 * * *"
    # 每周一 04:00 UTC：vscode dev 镜像追 baseimage-ubuntu:noble（节省 CI）
    - cron: "0 4 * * 1"
    # 说明：webtop 也归入 weekly 组（见下方 matrix 配置），同样在周一 schedule 跑

permissions:
  contents: read
  packages: write

jobs:
  plan:
    name: 计划本次要构建的镜像集合
    runs-on: ubuntu-latest
    outputs:
      # 是否存在需要使用 standard 构建器的镜像
      has_standard: ${{ steps.gen.outputs.has_standard }}
      # standard 构建器的 matrix（include 数组）
      matrix_standard: ${{ steps.gen.outputs.matrix_standard }}
    steps:
      - uses: actions/checkout@v4

      # push 场景：检测哪些 images/<name> 目录发生变更（paths-filter 输出 true/false）
      - name: 计算哪些镜像目录发生了变更（push 场景）
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            n8n:
              - "images/n8n/**"
            n8n-runners:
              - "images/n8n-runners/**"
            vscode-ssh-dev:
              - "images/vscode-ssh-dev/**"
            webtop:
              - "images/webtop/**" # ✅ 新增：webtop 目录变更检测

      # 生成 matrix：
      # - schedule：按 cron 分流（fast/weekly）
      # - push：仅构建发生变更的镜像
      # - workflow_dispatch：按 target 选择（all 或单个）
      - name: 生成 matrix（schedule=按 cron 分组，push=仅变更，dispatch=按选择）
        id: gen
        env:
          EVENT_NAME: ${{ github.event_name }}
          TARGET: ${{ github.event.inputs.target }}
          SCHEDULE: ${{ github.event.schedule }}

          CHANGED_N8N: ${{ steps.filter.outputs.n8n }}
          CHANGED_RUNNERS: ${{ steps.filter.outputs.n8n-runners }}
          CHANGED_VSCODE: ${{ steps.filter.outputs.vscode-ssh-dev }}
          CHANGED_WEBTOP: ${{ steps.filter.outputs.webtop }} # ✅ 新增
        run: |
          python - <<'PY'
          import json, os

          event = os.getenv("EVENT_NAME")
          target = (os.getenv("TARGET") or "").strip() or "all"
          schedule = (os.getenv("SCHEDULE") or "").strip()

          # push 场景：根据 paths-filter 输出决定哪些镜像被选中
          changed = {
            "n8n": (os.getenv("CHANGED_N8N", "false") == "true"),
            "n8n-runners": (os.getenv("CHANGED_RUNNERS", "false") == "true"),
            "vscode-ssh-dev": (os.getenv("CHANGED_VSCODE", "false") == "true"),
            "webtop": (os.getenv("CHANGED_WEBTOP", "false") == "true"),
          }

          # 镜像注册表：新增镜像只加一段
          # 每个 item 对应一次对 reusable workflow（_build-image.yml）的调用参数
          all_items = [
            {
              "builder": "standard",
              "schedule_group": "fast",
              "image_name": "n8n",
              "context": "images/n8n",
              "dockerfile": "images/n8n/Dockerfile",
              "upstream_image": "ghcr.io/n8n-io/n8n",
              "version_source": "github_release",
              "upstream_repo": "n8n-io/n8n",
              "version_sed": "s/^v//; s/^n8n@//",
              "upstream_tag_template": "{version}",
              "version_arg_name": "N8N_VERSION",
              "push_digest_tag": False,
              "concurrency_group": "build-n8n",
            },
            {
              "builder": "standard",
              "schedule_group": "fast",
              "image_name": "n8n-runners",
              "context": "images/n8n-runners",
              "dockerfile": "images/n8n-runners/Dockerfile",
              "upstream_image": "ghcr.io/n8n-io/runners",
              "version_source": "github_release",
              "upstream_repo": "n8n-io/n8n",
              "version_sed": "s/^v//; s/^n8n@//",
              "upstream_tag_template": "{version}",
              "version_arg_name": "RUNNERS_VERSION",
              "push_digest_tag": True,
              "concurrency_group": "build-n8n-runners",
            },
            {
              "builder": "standard",
              "schedule_group": "weekly",
              "image_name": "vscode-ssh-dev",
              "context": "images/vscode-ssh-dev",
              "dockerfile": "images/vscode-ssh-dev/Dockerfile",
              # 上游是 LSIO Ubuntu base（tag 模式）
              "upstream_image": "lscr.io/linuxserver/baseimage-ubuntu",
              "version_source": "tag",
              "upstream_tag": "noble",
              "version_arg_name": "",
              "push_digest_tag": True,
              "concurrency_group": "build-vscode-ssh-dev",
            },
            {
              # ✅ 新增：webtop（薄封装）
              # 说明：
              # - 上游使用 tag 表示变体，这里选 ubuntu-xfce
              # - version_source=tag：version=upstream_tag，用于推送本仓库镜像的 :ubuntu-xfce tag
              # - 触发策略仍由 build_key 决定：上游 digest 或本地 context 变化才会重建
              "builder": "standard",
              "schedule_group": "weekly",
              "image_name": "webtop",
              "context": "images/webtop",
              "dockerfile": "images/webtop/Dockerfile",
              "upstream_image": "lscr.io/linuxserver/webtop",
              "version_source": "tag",
              "upstream_tag": "ubuntu-xfce",
              "version_arg_name": "",
              "push_digest_tag": True,
              "concurrency_group": "build-webtop",
            },
          ]

          def schedule_should_include(item):
            # 通过触发本次 schedule 的 cron 字符串来分流
            # - 0 */6 * * * -> fast
            # - 0 4 * * 1   -> weekly
            if schedule == "0 */6 * * *":
              return item.get("schedule_group") == "fast"
            if schedule == "0 4 * * 1":
              return item.get("schedule_group") == "weekly"
            # 兜底：未知 schedule 时全量
            return True

          def should_include(item):
            name = item["image_name"]
            if event == "schedule":
              return schedule_should_include(item)
            if event == "workflow_dispatch":
              return (target == "all") or (target == name)
            # push
            return changed.get(name, False)

          selected = [i for i in all_items if should_include(i)]

          # 未来如果你有“超出标准构建器”的镜像：
          #   - 给 item 填 builder="signed"/"special"
          #   - 在 build.yml 里新增 build_signed/build_special job
          standard = [i for i in selected if i.get("builder") == "standard"]

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"has_standard={'true' if standard else 'false'}\n")
            f.write("matrix_standard=" + json.dumps({"include": standard}) + "\n")
          PY

  build_standard:
    name: 构建并推送（standard）
    needs: plan
    # 若本次计划里没有 standard 镜像，则不执行
    if: needs.plan.outputs.has_standard == 'true'
    strategy:
      fail-fast: false
      # matrix 由 plan job 动态生成
      matrix: ${{ fromJSON(needs.plan.outputs.matrix_standard) }}

    # 复用通用构建工作流
    uses: ./.github/workflows/_build-image.yml
    with:
      image_name: ${{ matrix.image_name }}
      context: ${{ matrix.context }}
      dockerfile: ${{ matrix.dockerfile }}

      upstream_image: ${{ matrix.upstream_image }}
      version_source: ${{ matrix.version_source }}

      upstream_repo: ${{ matrix.upstream_repo }}
      version_sed: ${{ matrix.version_sed }}
      upstream_tag_template: ${{ matrix.upstream_tag_template }}

      upstream_tag: ${{ matrix.upstream_tag }}

      version_arg_name: ${{ matrix.version_arg_name }}

      # 推送策略（可按镜像差异调整）
      push_latest: true
      push_version: true
      push_build_key: true
      push_digest_tag: ${{ matrix.push_digest_tag }}

      concurrency_group: ${{ matrix.concurrency_group }}

      enable_provenance: true
      enable_sbom: true