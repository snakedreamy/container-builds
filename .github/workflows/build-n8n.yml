name: 构建并发布 n8n 镜像

on:
  # 你改了 n8n 镜像相关文件才触发（README.md 不会触发，因为不在 paths 里）
  push:
    branches: [ "main" ]
    paths:
      - "images/n8n/**"
      - ".github/workflows/build-n8n.yml"

  # 手动触发
  workflow_dispatch:

  # 定时检查上游 n8n 是否发布新版本
  schedule:
    - cron: "0 */6 * * *"  # 每 6 小时一次（UTC）

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 获取上游 n8n 最新稳定 release 版本号
      - name: 获取上游 n8n 最新版本号
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RAW_TAG="$(
            curl -fsSL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/n8n-io/n8n/releases/latest \
            | jq -r '.tag_name'
          )"

          echo "上游返回原始 tag_name：${RAW_TAG}"

          # 清洗 tag：
          # - v2.7.5 -> 2.7.5
          # - n8n@2.7.5 -> 2.7.5
          N8N_VERSION="${RAW_TAG#v}"
          N8N_VERSION="${N8N_VERSION##*@}"

          # 基本校验：必须是 x.y.z
          if ! echo "${N8N_VERSION}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "解析后的版本号不符合预期：${N8N_VERSION}（原始：${RAW_TAG}）" >&2
            exit 1
          fi

          echo "n8n_version=${N8N_VERSION}" >> "$GITHUB_OUTPUT"
          echo "解析后的 n8n_version：${N8N_VERSION}"

      # 2) 登录 GHCR
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3) 如果 GHCR 已经存在该版本 tag，就跳过构建（避免 schedule 重复构建）
      - name: 如果 GHCR 已有该版本则跳过
        id: check
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${{ github.repository_owner }}/n8n:${{ steps.upstream.outputs.n8n_version }}"
          if docker manifest inspect "${IMAGE}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "GHCR 已存在：${IMAGE}，跳过构建"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "GHCR 不存在：${IMAGE}，将执行构建"
          fi

      # 4) 多架构构建需要 QEMU（仅在要构建时启用）
      - name: 启用 QEMU（跨架构构建）
        if: steps.check.outputs.exists != 'true'
        uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists != 'true'

      # 5) 构建并推送（同时发布 amd64 + arm64）
      - name: 构建并推送 n8n 镜像（多架构）
        if: steps.check.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          # 建议把构建上下文收敛到镜像目录（更干净）
          context: images/n8n
          file: images/n8n/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            N8N_VERSION=${{ steps.upstream.outputs.n8n_version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n:latest
            ghcr.io/${{ github.repository_owner }}/n8n:${{ steps.upstream.outputs.n8n_version }}
            ghcr.io/${{ github.repository_owner }}/n8n:sha-${{ github.sha }}